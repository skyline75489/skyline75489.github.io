<!DOCTYPE html> 
<html>
<head>
<title>Skyline75489</title>
 <meta charset='utf-8'>
<link rel="stylesheet" href="../static/styles/github.css">
<link rel="stylesheet" href="../static/post.css">
</head>
<body>

<div class="wrapper">
<div class="header">
	<span class="blog-name">Skyline75489</span>

<a class="nav" href="../index.html">Home</a>
<a class="nav" href="about.html">About</a>
</div>
<div class="content">

<h1>C# Native Interop：从入门到再次入门</h1>
<h2>C# 与 Native API 的互操作性</h2>
<p>.NET 平台对于 C/C++ 等 Native 库具有良好的互操作性，其中一部分原因是，微软本身在实现 .NET Framework 的过程中发现，Win32 API 经过多年的发展已经过于庞大，大到无法也没有必要使用 C# 全部重新实现一遍，不如直接通过 C# 调用 Win32 API 来的实际。如今 .NET Framework 中很多类库到最底层也是使用的 Win32 或 COM 的 API。因此，当我们自己需要调用 C++ 类库时也可以放心大胆的使用 C# 的互操作技术。</p>
<p>目前 .NET 平台提供了下面三种互操作技术：</p>
<ol>
<li>Platform Invoke(P/Invoke)，主要用于调用 C/C++ 库函数和 Windows API</li>
<li>C++/CLI Interop, 即在 Managed C++(托管C++)中调用 C/C++ 类库</li>
<li>COM Interop, 主要用于在 .NET 中调用 COM 组件</li>
</ol>
<p>其中 C++/CLI Interop 实质上和 P/Invoke 技术在底层实现上是一致的，只是在上层使用上有所差异。因此本文对于 C++/CLI 不再单独讲述，感兴趣的读者可以自行查阅有关资料。本文就 P/Invoke 和 COM Interop 两种技术进行一些探讨，希望能给读者以启发和收获。</p>
<h2>P/Invoke</h2>
<p>P/Invoke 的前身是当年微软专属的 Java 实现 J++ 当中使用的 J/Direct 技术。和 JNI 技术不同，J/Direct 通过跨过 Java 虚拟机直接和 Native 代码进行交互达到了相对更高的性能。后来随着 .NET 技术的兴起，J/Direct 也在 .NET 的世界里以 P/Invoke 的方式得到的重生。</p>
<p>P/Invoke 依托于 CLR 和 JIT，实现了在 .NET 平台对于非托管 DLL 的加载和调用。在介绍 P/Invoke 之前，我们首先了解一下非托管 DLL 的有关知识。</p>
<h3>Native DLL</h3>
<p>DLL 是 Windows 平台上专属的动态库格式。</p>
<h4>DLL 导出</h4>
<h4>DLL Runtime Linking</h4>
<h3>blittable 类型</h3>
<h3>托管堆与非托管堆</h3>
<h3>Calling Convention</h3>
<h2>COM Interop</h2>
<h3>COM - A Better C++</h3>
<h3>COM 内存机制</h3>
<h3>COM 与 C</h3>
<h2>参考资料</h2>
<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/eaw10et3(v=vs.110).aspx">https://msdn.microsoft.com/en-us/library/eaw10et3(v=vs.110).aspx</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/04fy9ya1(v=vs.80).aspx">https://msdn.microsoft.com/en-us/library/04fy9ya1(v=vs.80).aspx</a></li>
<li><a href="https://msdn.microsoft.com/zh-cn/library/aa686045.aspx">https://msdn.microsoft.com/zh-cn/library/aa686045.aspx</a></li>
<li><a href="https://www.codeproject.com/Articles/28969/HowTo-Export-C-classes-from-a-DLL">https://www.codeproject.com/Articles/28969/HowTo-Export-C-classes-from-a-DLL</a></li>
</ul>


</div>
</div>
<script src="../static/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>

</html>
